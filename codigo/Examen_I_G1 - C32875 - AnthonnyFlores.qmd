---
format:
  html:
    self-contained: true
    theme: darkly
    code-fold: true 
---
::: text-center
# UCR

## Escuela de Matemática

### Herramientas de Ciencias de Datos I (CA-0204)

### Examen II

**Profesor**: Luis Juárez Potoy

**Estudiante**:\
Anthonny Flores Rojas (C32975)

**Fecha**: 30 de noviembre de 2025
:::

------------------------------------------------------------------------

# 1

```{r, warning=FALSE}

# Librerias
library(tidyverse)
library(readr)

# Data frame con los datos
df <- read.csv("C:/Users/antho/Documents/UCR/Semestre_I_2025/CA0204/Examen2/CA0204-Examen_II_C32975/data/moras.txt", stringsAsFactors = FALSE)


# Correcion de error
df <- df %>%
  rename(INDICADOR_EXTRANJERO = INDICADOR.EXTRANJERO)

 
head(df)

```

# 2

```{r}

# Variables numericas
numeric <- c("IDENTIFICACION","SALARIO","EDAD")

# Correcion de tipo
df$SALARIO <- as.numeric(gsub(",", ".", df$SALARIO))


# Resumen
summary <- df %>%
  summarise(
    IDENTIFICACION_promedio = mean(IDENTIFICACION, na.rm = TRUE),
    IDENTIFICACION_mediana  = median(IDENTIFICACION, na.rm = TRUE),
    IDENTIFICACION_sd       = sd(IDENTIFICACION, na.rm = TRUE),
    IDENTIFICACION_min      = min(IDENTIFICACION, na.rm = TRUE),
    IDENTIFICACION_max      = max(IDENTIFICACION, na.rm = TRUE),
    
    SALARIO_promedio = mean(SALARIO, na.rm = TRUE),
    SALARIO_mediana  = median(SALARIO, na.rm = TRUE),
    SALARIO_sd       = sd(SALARIO, na.rm = TRUE),
    SALARIO_min      = min(SALARIO, na.rm = TRUE),
    SALARIO_max      = max(SALARIO, na.rm = TRUE),

    EDAD_promedio = mean(EDAD, na.rm = TRUE),
    EDAD_mediana  = median(EDAD, na.rm = TRUE),
    EDAD_sd       = sd(EDAD, na.rm = TRUE),
    EDAD_min      = min(EDAD, na.rm = TRUE),
    EDAD_max      = max(EDAD, na.rm = TRUE)
  )

print(summary)

```
# 3

```{r}

# Meter los valores atipicos
df <- df %>%
  mutate(
    VALOR_ATIPICO_SALARIO = ifelse(!is.na(SALARIO) & abs((SALARIO - mean(SALARIO, na.rm=TRUE))/sd(SALARIO, na.rm=TRUE)) > 1.96, "SI", "NO"),
    VALOR_ATIPICO_EDAD    = ifelse(!is.na(EDAD)    & abs((EDAD    - mean(EDAD,    na.rm=TRUE))/sd(EDAD,    na.rm=TRUE)) > 1.96, "SI", "NO")
  )

head(df)
```

# 4

```{r}
# Porcentajes de NA
na.percentange <- colMeans(is.na(df)) * 100

print(na.percentange)

```
# 5

```{r}

# Cambiar NA por mediana igual a excel
df <- df %>%
  mutate(
    SALARIO = ifelse(is.na(SALARIO), median(SALARIO, na.rm = TRUE), SALARIO),
    EDAD    = ifelse(is.na(EDAD),    median(EDAD,    na.rm = TRUE), EDAD)
  )

na.percentange <- colMeans(is.na(df)) * 100

print(na.percentange)

```

# 6 
```{r}

library(ggplot2)
library(forcats)

# Definir columnas
cot <- c("SEXO","TIPO_ASEGURAMIENTO","SECTOR", "INDICADOR_ACTIVO","INDICADOR_EXTRANJERO", "INDICADOR_MOROSO","VALOR_ATIPICO_SALARIO")

cat <- c("SALARIO","EDAD")

# Todas las demas
for (var in cot) {
  print(
    ggplot(df, aes(x = fct_infreq(.data[[var]]))) +
      geom_bar(fill = "#2F77B3") +
      labs(title = paste("Cantidad por", var), x = var, y = "n") +
      theme_minimal()
  )
}

# Salario y edad
ggplot(df, aes(x = "SALARIO", y = SALARIO)) +
  geom_jitter(width = 0.2, color = "steelblue", alpha = 0.6) +
  scale_y_log10() +
  labs(title = "Distribucion de SALARIO",
       x = "", y = "SALARIO") +
  theme_minimal()

ggplot(df, aes(x = EDAD)) +
  geom_histogram(fill = "lightblue", bins = 30, alpha = 0.5) +
  geom_density(color = "black", size = 1) +
  labs(title = "Distribucion de EDAD", x = "EDAD", y = "Frecuencia") +
  theme_minimal()


```

# 7 y 8

```{r}

# Definir columnas
cot <- c("SEXO","TIPO_ASEGURAMIENTO","SECTOR",
         "INDICADOR_ACTIVO","INDICADOR_EXTRANJERO",
         "VALOR_ATIPICO_SALARIO")

cat <- c("SALARIO","EDAD")


for (var in cot) {
  plot <- df %>%
    group_by(.data[[var]], INDICADOR_MOROSO) %>%
    summarise(n = n(), .groups = "drop") %>%
    mutate(pct = n / sum(n) * 100,
           lado = ifelse(INDICADOR_MOROSO == "SI", -pct, pct)) %>%
    ggplot(aes(x = fct_infreq(.data[[var]]), y = lado, fill = INDICADOR_MOROSO)) +
      geom_col() +
      coord_flip() +
      scale_fill_manual(values = c("SI" = "pink", "NO" = "lightblue")) +
      labs(title = paste("Distribucion de morosidad por", var),
           x = var, y = "%") +
      theme_minimal() 
  
  print(plot) 
}

# Edad
df %>%
  mutate(grupo_edad = cut(EDAD, breaks = seq(0, max(EDAD, na.rm = TRUE), by = 5))) %>%
  group_by(grupo_edad, INDICADOR_MOROSO) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(n = ifelse(INDICADOR_MOROSO == "SI", -n, n)) %>%
  ggplot(aes(x = grupo_edad, y = n, fill = INDICADOR_MOROSO)) +
    geom_col() +
    coord_flip() +
    scale_fill_manual(values = c("SI" = "pink", "NO" = "lightblue")) +
    labs(title = "Distribucion de EDAD segun morosidad",
         x = "Grupo de edad", y = "Frecuencia") +
    theme_minimal()

# Salario
df %>%
  mutate(grupo_salario = cut(SALARIO, breaks = 20)) %>%
  group_by(grupo_salario, INDICADOR_MOROSO) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(n = ifelse(INDICADOR_MOROSO == "SI", -n, n)) %>%
  ggplot(aes(x = grupo_salario, y = n, fill = INDICADOR_MOROSO)) +
    geom_col() +
    coord_flip() +
    scale_fill_manual(values = c("SI" = "pink", "NO" = "lightblue")) +
    labs(title = "Distribucion de SALARIO segun morosidad",
         x = "Grupo de salario", y = "Frecuencia") +
    theme_minimal()


```

# 10

```{r}

library(rpart)
library(rpart.plot)

# Eliminar indentificacion
df.mod <- df %>%
  select(-IDENTIFICACION)   # ajusta el nombre de la columna de ID

df.mod <- df.mod %>%
  mutate(
    INDICADOR_MOROSO = factor(INDICADOR_MOROSO,
                              levels = c("SI","NO"),
                              labels = c("Moroso","No Moroso")),
    TIPO_ASEGURAMIENTO = if_else(TIPO_ASEGURAMIENTO == "TRABAJADOR INDEPENDIENTE",
                                 "TRABAJADOR INDEPENDIENTE", "NO")
  )


# Arbol
tree <- rpart(INDICADOR_MOROSO ~ ., data = df.mod, method = "class")

# Graficar arbol
rpart.plot(tree, type = 4, extra = 104, box.palette = "Blues", shadow.col = "gray", nn = TRUE, branch.lty = 2)



```

Este árbol permite dividir la información en agrupaciones representativas, facilitando el análisis enfocado del indicador de morosidad. A través de esta subdivisión, se identifican los grupos con mayor riesgo: los asegurados independientes (comúnmente conocidos como trabajadores autónomos) presentan el perfil más propenso a la morosidad, y dentro de este grupo, el riesgo se incrementa significativamente en personas extranjeras. Para los nacionales, el riesgo también aumenta si el salario supera los ₡300.000. Esta estructura jerárquica de decisiones permite desglosar y distinguir, mediante probabilidad condicional, la probabilidad de morosidad de cada cliente según sus características.

Estas ideas apoyan los resultados dados en el Excel en los pasos anteriores. El hecho de ser extranjeros y ser independientes generalmente corresponde a personas que no tienen ideales de quedarse en el país, sino de llevar lo ganado a su tierra natal, lo que para ellos implica que el aseguramiento sea más un gasto que una inversión, desde su punto de vista.
